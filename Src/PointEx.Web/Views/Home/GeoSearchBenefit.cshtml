@using Framework.Common.Extentensions
@using PointEx.Web.Infrastructure.Extensions
@using PointEx.Web.Models
@using PointEx.Entities.Enums
@model PointEx.Web.Models.GeolocalizationModel
@{
    ViewBag.Title = "Home Page";
}
<div class="form-horizontal">
    <div class="form-group">

    </div>
</div>
<script src="../Scripts/jquery-2.1.3.js"></script>
<div id="floating-panel">
    <input id="address" type="text" style="width:300px">
    <input id="submit" type="button" value="Geocode">
</div>
<div id="autoLocation">
    <input type="text" id="lat" value="-27.472245" />
    <input type="text" id="lon" value="-58.840182" />
    <input type="text" id="formatted_Address" value="Corrientes Argentina" />
</div>
<div id="map" style=" height: 350px;width:400px"></div>
<script>

    var map;
    var geocoder;
    var initialLocation;

    function positionError(position) {
        switch (position.code) {
            case 0:
                alert("Ha ocurrido un error inesperado.");
                break;
            case 1:
                alert("No se ha dado permiso para acceder a su ubicacion. Verifique la configuracion de su navegador.");
                break;
            case 2:
                alert("No se ha podido establecer su ubicacion.");
                break;
            case 3:
                alert("El tiempo para obtener su ubicacion a expirado.");
                break;
            default:
                break;
        }

        geocodeDefault();
    }

    function showPosition(position) {
        $('#lat').val(position.coords.latitude);
        $('#lon').val(position.coords.longitude);
        initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        map.setCenter(initialLocation);
        var marker = new google.maps.Marker({
            map: map,
            position: initialLocation
        });
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 14,
            center: { lat: 0, lng: 0 },
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });
        geocoder = new google.maps.Geocoder();

        if (navigator.geolocation) {
            var options = {
                enabledHighAccuracy: true,
                timeout: 20000,
                maximumAge: 2000
            }
            navigator.geolocation.getCurrentPosition(showPosition, positionError, options);
        }
        else {
            alert("La localizacion esta deshabilitada. Si desea utilizar su ubicacion actual, habilite la geolocalizacion en su navegador.");
            geocodeDefault();
        }

        document.getElementById('submit').addEventListener('click', function () {
            geocodeAddress();
        });
    }

    function geocodeDefault() {
        var address = document.getElementById('formatted_Address').value;
        geocoder.geocode({ 'address': address }, function (results, status) {
            if (status === google.maps.GeocoderStatus.OK) {
                map.setCenter(results[0].geometry.location);
                var marker = new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location
                });
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }
        });
    }

    function geocodeAddress() {
        var address = document.getElementById('address').value;
        var postfijo = document.getElementById('formatted_Address').value;
        geocoder.geocode({ 'address': address + ' ' + postfijo }, function (results, status) {
            if (status === google.maps.GeocoderStatus.OK) {
                map.setCenter(results[0].geometry.location);
                var marker = new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location
                });
 
                $.ajax({
                    type: "POST",
                    url: '/Home/GeoSearchBenefit',
                    data: { latitude: results[0].geometry.location.lat(), longitude: results[0].geometry.location.lng(), distance: 0.5 },
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: successFunc,
                    error: errorFunc
                });

                function successFunc(data, status) {
                    alert(data);
                }

                function errorFunc() {
                    alert('error');
                }
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }
        });
    }

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAsWT3WM2Wkqlcz9aqPhLJ93WPyiXP2Yrc&signed_in=true&callback=initMap" async defer></script>