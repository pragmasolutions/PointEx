@using Framework.Common.Extentensions
@using PointEx.Web.Infrastructure.Extensions
@using PointEx.Web.Models
@using PointEx.Entities.Enums
@model PointEx.Web.Models.GeolocalizationModel
@{
    ViewBag.Title = "Home Page";
}

<style>
    .gm-style-iw {
        width: 350px !important;
        top: 15px !important;
        left: 0px !important;
        background-color: #fff;
        box-shadow: 0 1px 6px rgba(178, 178, 178, 0.6);
        border: 1px solid rgba(124, 162, 61, 0.6);
        border-radius: 2px 2px 10px 10px;
    }

    #iw-container {
        margin-bottom: 10px;
        min-width: 350px;
    }

        #iw-container .iw-title {
            font-family: 'Open Sans Condensed', sans-serif;
            font-size: 22px;
            font-weight: 400;
            padding: 10px;
            background-color: #7CA23D;
            color: white;
            margin: 0;
            border-radius: 2px 2px 0 0;
        }

        #iw-container .iw-content {
            font-size: 13px;
            line-height: 18px;
            font-weight: 400;
            margin-right: 1px;
            padding: 15px 5px 20px 15px;
            max-height: 140px;
            overflow-y: auto;
            overflow-x: hidden;
        }

    .iw-content img {
        float: right;
        margin: 0 5px 5px 10px;
    }

    .iw-subTitle {
        font-size: 16px;
        font-weight: 700;
        padding: 5px 0;
    }

    .iw-bottom-gradient {
        position: absolute;
        width: 326px;
        height: 25px;
        bottom: 10px;
        right: 18px;
        background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);
        background: -webkit-linear-gradient(top, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);
        background: -moz-linear-gradient(top, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);
        background: -ms-linear-gradient(top, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);
    }
</style>

<div class="form-horizontal">
    <div class="form-group">

    </div>
</div>
<script src="../Scripts/jquery-2.1.3.js"></script>
<div id="floating-panel">
    <form class="form-inline" id="search-nearest-benefits-form">
        <div class="row">
            <div class="form-group col-lg-9">
                <input id="address" class="form-control" style="max-width: none; width: 100%" type="text">
            </div>
            <div class="form-group col-lg-3">
                <input id="submit" type="submit" class="btn btn-primary" value="Buscar Beneficios" data-loading-text="Buscando...">
            </div>
        </div>
    </form>
</div>
<div id="autoLocation">
    <input type="hidden" id="lat" value="-27.472245" />
    <input type="hidden" id="lon" value="-58.840182" />
    <input type="hidden" id="formatted_Address" value="Corrientes Argentina" />
</div>
<div class="spacer"></div>
<div id="map" style=" height: 400px;width:100%"></div>
<script>

    var map;
    var geocoder;
    var initialLocation;

    var markers = [];

    function positionError(position) {
        switch (position.code) {
            case 0:
                alert("Ha ocurrido un error inesperado.");
                break;
            case 1:
                alert("No se ha dado permiso para acceder a su ubicacion. Verifique la configuracion de su navegador.");
                break;
            case 2:
                alert("No se ha podido establecer su ubicacion.");
                break;
            case 3:
                alert("El tiempo para obtener su ubicacion a expirado.");
                break;
            default:
                break;
        }

        centerMapInDefaultLocation();
    }

    function centerMapInDefaultLocation() {
        var address = document.getElementById('formatted_Address').value;
        geocoder.geocode({ 'address': address }, function (results, status) {
            if (status === google.maps.GeocoderStatus.OK) {
                map.setCenter(results[0].geometry.location);
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }
        });
    }

    function showPosition(position) {

        clearMarkers();

        $('#floating-panel').hide();
        $('#autoLocation').hide();

        $('#lat').val(position.coords.latitude);
        $('#lon').val(position.coords.longitude);

        initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

        map.setCenter(initialLocation);

        var marker = new google.maps.Marker({
            map: map,
            position: initialLocation,
            icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
        });

        markers.push(marker);

        getNearestBenfits(position.coords.latitude, position.coords.longitude);
    }

    function getNearestBenfits(latitude, longitude) {

        var $btnSubmit = $('#submit');

        $btnSubmit.button('loading');

        $.ajax({
            type: "GET",
            url: '/Home/NearestBenefits',
            data: { latitude: latitude, longitude: longitude, distance: 1000 },
            contentType: "application/json; charset=utf-8",
            dataType: "json"
        }).done(function (benefits) {

            if (!benefits || benefits.length === 0) {
                alert("No se encontraron beneficios cercanos");
                return;
            }

            //add a marker for each benefit
            for (var i = 0; i < benefits.length; i++) {
                var benefit = benefits[i];

                var benefitLocation = new google.maps.LatLng(benefit.latitude, benefit.longitude);

                var contentTemplate = _.template('<div id="iw-container">' +
                    '<div class="iw-title"><%= shopName %></div>' +
                    '<div class="iw-content">' +
                    '<div class="iw-subTitle"><%= benefitType %></div>' +
                    '<div class="row">' +
                    '<p class="col-lg-7" style="word-wrap: break-word;"><%= benefitDescription %>.' +
                    '<br><a href="<%= benefitDetailsUrl %>">' +
                    'Ir al detalle ' +
                    '</a>' +
                    '</p>' +
                    '<img src="<%= benefitImageUrl %>" alt="" height="115" width="83" class="col-lg-4"/>' +
                    '</div>' +
                    
                    '</div>' +
                    '<div class="iw-bottom-gradient"></div>' +
                    '</div>');

                var contentHtml = contentTemplate(benefit);

                var infowindow = new google.maps.InfoWindow({
                    content: contentHtml,
                    // Assign a maximum value for the width of the infowindow allows
                    // greater control over the various content elements
                    maxWidth: 350

                });

                var marker = new google.maps.Marker({
                    map: map,
                    position: benefitLocation,
                    title: benefit.shopName,
                    infowindow: infowindow
                });

                markers.push(marker);

                marker.addListener('click', function (e) {
                    var markerInfoWindow = this.infowindow;
                    if (markerInfoWindow) {
                        markerInfoWindow.open(map, this);
                    }
                });

                // *
                // START INFOWINDOW CUSTOMIZE.
                // The google.maps.event.addListener() event expects
                // the creation of the infowindow HTML structure 'domready'
                // and before the opening of the infowindow, defined styles are applied.
                // *
                google.maps.event.addListener(infowindow, 'domready', function () {

                    // Reference to the DIV that wraps the bottom of infowindow
                    var iwOuter = $('.gm-style-iw');

                    /* Since this div is in a position prior to .gm-div style-iw.
                     * We use jQuery and create a iwBackground variable,
                     * and took advantage of the existing reference .gm-style-iw for the previous div with .prev().
                    */
                    var iwBackground = iwOuter.prev();

                    // Removes background shadow DIV
                    iwBackground.children(':nth-child(2)').css({ 'display': 'none' });

                    // Removes white background DIV
                    iwBackground.children(':nth-child(4)').css({ 'display': 'none' });

                    // Moves the infowindow 115px to the right.
                    iwOuter.parent().parent().css({ left: '115px' });

                    // Moves the shadow of the arrow 76px to the left margin.
                    iwBackground.children(':nth-child(1)').attr('style', function (i, s) { return s + 'left: 76px !important;' });

                    // Moves the arrow 76px to the left margin.
                    iwBackground.children(':nth-child(3)').attr('style', function (i, s) { return s + 'left: 76px !important;' });

                    // Changes the desired tail shadow color.
                    iwBackground.children(':nth-child(3)').find('div').children().css({ 'box-shadow': 'rgba(124, 162, 61, 0.6) 0px 1px 6px', 'z-index': '1' });

                    // Reference to the div that groups the close button elements.
                    var iwCloseBtn = iwOuter.next();

                    // Apply the desired effect to the close button
                    iwCloseBtn.css({ '-webkit-box-sizing': 'content-box', '-moz-box-sizing': 'content-box', 'box-sizing': 'content-box', opacity: '1', right: '38px', top: '3px', border: '7px solid #7CA23D', 'border-radius': '13px', 'box-shadow': '0 0 5px #c7e298' });

                    // If the content of infowindow not exceed the set maximum height, then the gradient is removed.
                    if ($('.iw-content').height() < 140) {
                        $('.iw-bottom-gradient').css({ display: 'none' });
                    }

                    // The API automatically applies 0.7 opacity to the button after the mouseout event. This function reverses this event to the desired value.
                    iwCloseBtn.mouseout(function () {
                        $(this).css({ opacity: '1' });
                    });
                });

            }
        }).
        always(function () {
            $btnSubmit.button('reset');
        });
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 14,
            center: { lat: 0, lng: 0 },
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        geocoder = new google.maps.Geocoder();

        if (navigator.geolocation) {
            var options = {
                enabledHighAccuracy: true,
                timeout: 20000,
                maximumAge: 2000
            }
            navigator.geolocation.getCurrentPosition(showPosition, positionError, options);
        } else {
            alert("La localizacion esta deshabilitada. Si desea utilizar su ubicacion actual, habilite la geolocalizacion en su navegador o ingrese su direccion actual en el campo de busqueda y haga click en buscar");
        }

        var input = document.getElementById('address');

        var autocomplete = new google.maps.places.Autocomplete(input);

        $('#search-nearest-benefits-form').submit(function () {
            geocodeAddress();
            return false;
        });
    }

    function geocodeDefault() {
        var address = document.getElementById('formatted_Address').value;
        geocoder.geocode({ 'address': address }, function (results, status) {
            if (status === google.maps.GeocoderStatus.OK) {

                clearMarkers();

                map.setCenter(results[0].geometry.location);

                var marker = new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location
                });

                markers.push(marker);
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }
        });
    }

    function geocodeAddress() {
        var address = document.getElementById('address').value;
        var postfijo = document.getElementById('formatted_Address').value;
        geocoder.geocode({ 'address': address + ' ' + postfijo }, function (results, status) {
            if (status === google.maps.GeocoderStatus.OK) {

                clearMarkers();

                map.setCenter(results[0].geometry.location);

                var marker = new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location,
                    icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                });

                markers.push(marker);

                getNearestBenfits(results[0].geometry.location.lat(), results[0].geometry.location.lng());
            }
        });
    }

    // Sets the map on all markers in the array.
    function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
        }
    }

    // Removes the markers from the map, but keeps them in the array.
    function clearMarkers() {
        setMapOnAll(null);
    }

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCM0M-scUFxCaYqfphdSk-pEomD-W9Oyf4&signed_in=true&callback=initMap&libraries=places" async defer></script>